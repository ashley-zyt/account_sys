<% content_for :page_title do %>
  仪表盘
<% end %>
<% content_for :page_subtitle do %>
  账号与任务运行情况一览
<% end %>

<div class="admin-grid-three">
  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          账号概览
        </div>
        <div class="admin-card-subtitle">
          当前可用的社交账号资产
        </div>
      </div>
      <div class="admin-card-header-right">
        <span class="admin-tag admin-tag-accent">
          总计 <%= @accounts_total %> 个
        </span>
      </div>
    </div>

    <div class="admin-metric-row">
      <div class="admin-metric">
        <div class="admin-metric-label">
          正常
        </div>
        <div class="admin-metric-value">
          <%= @accounts_active %>
        </div>
        <div class="admin-metric-trend admin-metric-trend-up">
          可用状态
        </div>
      </div>
      <div class="admin-metric">
        <div class="admin-metric-label">
          未登录
        </div>
        <div class="admin-metric-value">
          <%= @accounts_unlogged %>
        </div>
        <div class="admin-metric-trend">
          需重新授权
        </div>
      </div>
      <div class="admin-metric">
        <div class="admin-metric-label">
          封禁/停用
        </div>
        <div class="admin-metric-value">
          <%= @accounts_banned %>
        </div>
        <div class="admin-metric-trend admin-metric-trend-down">
          不可用
        </div>
      </div>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header" style="margin-bottom: 12px;">
      <div>
        <div class="admin-card-title">
          平台分布
        </div>
        <div class="admin-card-subtitle">
          各社交平台账号状态
        </div>
      </div>
    </div>
    <div class="admin-table-wrapper" style="border: none; background: transparent; padding: 0;">
      <table class="admin-table" style="font-size: 12px;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.3);">
            <th style="padding: 8px;">平台</th>
            <th style="padding: 8px; text-align: center;">总计</th>
            <th style="padding: 8px; text-align: center;">正常</th>
            <th style="padding: 8px; text-align: center;">未登录</th>
            <th style="padding: 8px; text-align: center;">封禁</th>
          </tr>
        </thead>
        <tbody>
          <% Account.platforms.keys.each do |platform| %>
            <% stats = @platform_stats[platform] || { total: 0, active: 0, unlogged: 0, banned: 0 } %>
            <tr>
              <td style="padding: 8px;">
                <span class="admin-label-muted" style="text-transform: capitalize;"><%= platform %></span>
              </td>
              <td style="padding: 8px; text-align: center;"><%= stats[:total] %></td>
              <td style="padding: 8px; text-align: center; color: var(--success);"><%= stats[:active] %></td>
              <td style="padding: 8px; text-align: center; color: var(--warning);"><%= stats[:unlogged] %></td>
              <td style="padding: 8px; text-align: center; color: var(--danger);"><%= stats[:banned] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          浏览器概览
        </div>
        <div class="admin-card-subtitle">
          指纹浏览器节点状态
        </div>
      </div>
      <div class="admin-card-header-right">
        <span class="admin-tag">
          总计 <%= @browsers_total %> 个
        </span>
      </div>
    </div>

    <div class="admin-metric-row">
      <div class="admin-metric">
        <div class="admin-metric-label">
          正常
        </div>
        <div class="admin-metric-value">
          <%= @browsers_normal %>
        </div>
        <div class="admin-metric-trend admin-metric-trend-up">
          连接正常
        </div>
      </div>
      <div class="admin-metric">
        <div class="admin-metric-label">
          网络问题
        </div>
        <div class="admin-metric-value">
          <%= @browsers_network_error %>
        </div>
        <div class="admin-metric-trend admin-metric-trend-down">
          代理异常
        </div>
      </div>
      <div class="admin-metric">
        <div class="admin-metric-label">
          平均账号
        </div>
        <div class="admin-metric-value">
          <%= @browsers_total.positive? ? (@accounts_total.to_f / @browsers_total).round(1) : 0 %>
        </div>
        <div class="admin-metric-trend">
          单浏览器负载
        </div>
      </div>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          任务状态分布
        </div>
        <div class="admin-card-subtitle">
          调度队列当前负载
        </div>
      </div>
      <div class="admin-card-header-right">
        <span class="admin-tag">
          总任务 <%= @move_tasks_total %>
        </span>
      </div>
    </div>

    <div class="admin-kpi">
      <div class="admin-kpi-item">
        <div class="admin-kpi-label">
          待分配
        </div>
        <div class="admin-kpi-value">
          <%= @move_tasks_pending %>
        </div>
      </div>
      <div class="admin-kpi-item">
        <div class="admin-kpi-label">
          队列中
        </div>
        <div class="admin-kpi-value">
          <%= @move_tasks_waiting + @move_tasks_executing %>
        </div>
      </div>
      <div class="admin-kpi-item">
        <div class="admin-kpi-label">
          成功
        </div>
        <div class="admin-kpi-value" style="color: var(--success);">
          <%= @move_tasks_success %>
        </div>
      </div>
      <div class="admin-kpi-item">
        <div class="admin-kpi-label">
          失败
        </div>
        <div class="admin-kpi-value" style="color: var(--error);">
          <%= @move_tasks_failed %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="admin-grid-full">
  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          最新任务
        </div>
        <div class="admin-card-subtitle">
          最近创建的任务队列
        </div>
      </div>
      <div class="admin-card-header-right">
        <span class="admin-tag">
          最近 <%= @recent_tasks.size %> 条
        </span>
        <%= link_to "查看全部", admin_move_tasks_path, class: "admin-link-quiet" %>
      </div>
    </div>

    <% if @recent_tasks.any? %>
      <div class="admin-table-wrapper admin-table-scroll">
        <table class="admin-table">
          <thead>
            <tr>
              <th>
                任务
              </th>
              <th>
                平台
              </th>
              <th>
                账号
              </th>
              <th>
                状态
              </th>
              <th>
                创建时间
              </th>
            </tr>
          </thead>
          <tbody>
            <% @recent_tasks.each do |task| %>
              <tr>
                <td>
                  <%= link_to truncate(task.title.presence || task.video_url, length: 40), admin_move_task_path(task), class: "admin-link-quiet" %>
                </td>
                <td>
                  <span class="admin-label-muted">
                    <%= task.platform %>
                  </span>
                </td>
                <td>
                  <% if task.account %>
                    <%= link_to task.account.account_name, admin_account_path(task.account), class: "admin-link-quiet" %>
                  <% else %>
                    <span class="admin-label-muted">
                      未分配
                    </span>
                  <% end %>
                </td>
                <td>
                  <% case task.status %>
                  <% when "pending" %>
                    <span class="admin-pill-status admin-pill-status-pending">
                      <span class="admin-pill-status-dot"></span>
                      待分配
                    </span>
                  <% when "waiting_publish", "executing" %>
                    <span class="admin-pill-status admin-pill-status-pending">
                      <span class="admin-pill-status-dot"></span>
                      队列中
                    </span>
                  <% when "success" %>
                    <span class="admin-pill-status admin-pill-status-success">
                      <span class="admin-pill-status-dot"></span>
                      成功
                    </span>
                  <% when "failed" %>
                    <span class="admin-pill-status admin-pill-status-failed">
                      <span class="admin-pill-status-dot"></span>
                      失败
                    </span>
                  <% end %>
                </td>
                <td>
                  <span class="admin-label-muted">
                    <%= task.created_at&.strftime("%m-%d %H:%M") %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="admin-empty-state">
        暂无任务数据。
      </div>
    <% end %>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          快速导航
        </div>
        <div class="admin-card-subtitle">
          常用列表入口
        </div>
      </div>
    </div>

    <ul class="admin-list">
      <li class="admin-list-item">
        <div class="admin-list-title-row">
          <div class="admin-list-title">
            账号管理
          </div>
          <span class="admin-badge">
            <%= @accounts_total %>
          </span>
        </div>
        <div class="admin-list-meta">
          查看所有绑定的社交账号
        </div>
        <div>
          <%= link_to "进入列表", admin_accounts_path, class: "admin-link-quiet" %>
        </div>
      </li>

      <li class="admin-list-item">
        <div class="admin-list-title-row">
          <div class="admin-list-title">
            浏览器管理
          </div>
          <span class="admin-badge">
            <%= @browsers_total %>
          </span>
        </div>
        <div class="admin-list-meta">
          管理指纹浏览器与代理配置
        </div>
        <div>
          <%= link_to "进入列表", admin_browsers_path, class: "admin-link-quiet" %>
        </div>
      </li>

      <li class="admin-list-item">
        <div class="admin-list-title-row">
          <div class="admin-list-title">
            任务队列
          </div>
          <span class="admin-badge">
            <%= @move_tasks_total %>
          </span>
        </div>
        <div class="admin-list-meta">
          监控任务调度与执行情况
        </div>
        <div>
          <%= link_to "查看任务", admin_move_tasks_path, class: "admin-link-quiet" %>
        </div>
      </li>
    </ul>

    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
      <div class="admin-card-subtitle" style="margin-bottom: 12px;">
        今日系统运行
      </div>
      <div style="display: flex; gap: 20px;">
        <div>
          <div class="admin-label-muted" style="font-size: 11px;">
            产生日志
          </div>
          <div style="font-size: 18px; font-weight: 600;">
            <%= @today_logs_count %>
          </div>
        </div>
        <div>
          <div class="admin-label-muted" style="font-size: 11px;">
            异常次数
          </div>
          <div style="font-size: 18px; font-weight: 600; color: <%= @today_errors_count > 0 ? 'var(--error)' : 'var(--text-primary)' %>;">
            <%= @today_errors_count %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

