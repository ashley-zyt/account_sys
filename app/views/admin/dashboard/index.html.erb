<% content_for :page_title do %>
  仪表盘
<% end %>
<% content_for :page_subtitle do %>
  账号与任务运行情况一览
<% end %>

<div class="admin-grid-three">
  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          账号概览
        </div>
        <div class="admin-card-subtitle">
          当前可用的社交账号资产
        </div>
      </div>
      <div class="admin-card-header-right">
        <%= link_to admin_accounts_path, class: "admin-tag admin-tag-accent" do %>
          总计 <%= @accounts_total %> 个
        <% end %>
      </div>
    </div>

    <div class="admin-metric-row">
      <%= link_to admin_accounts_path(q: { status_eq: 0 }), class: "admin-metric admin-link-card" do %>
        <div class="admin-metric-label">
          正常
        </div>
        <div class="admin-metric-value">
          <%= @accounts_active %>
        </div>
        <div class="admin-metric-trend admin-metric-trend-up">
          可用状态
        </div>
      <% end %>
      <%= link_to admin_accounts_path(q: { status_eq: 1 }), class: "admin-metric admin-link-card" do %>
        <div class="admin-metric-label">
          未登录
        </div>
        <div class="admin-metric-value">
          <%= @accounts_unlogged %>
        </div>
        <div class="admin-metric-trend">
          需重新授权
        </div>
      <% end %>
      <%= link_to admin_accounts_path(q: { status_eq: 2 }), class: "admin-metric admin-link-card" do %>
        <div class="admin-metric-label">
          封禁/停用
        </div>
        <div class="admin-metric-value">
          <%= @accounts_banned %>
        </div>
        <div class="admin-metric-trend admin-metric-trend-down">
          不可用
        </div>
      <% end %>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header" style="margin-bottom: 12px;">
      <div>
        <div class="admin-card-title">
          平台分布
        </div>
        <div class="admin-card-subtitle">
          各社交平台账号状态
        </div>
      </div>
    </div>
    <div class="admin-table-wrapper" style="border: none; background: transparent; padding: 0;">
      <table class="admin-table" style="font-size: 12px;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.3);">
            <th style="padding: 8px;">平台</th>
            <th style="padding: 8px; text-align: center;">总计</th>
            <th style="padding: 8px; text-align: center;">正常</th>
            <th style="padding: 8px; text-align: center;">未登录</th>
            <th style="padding: 8px; text-align: center;">封禁</th>
          </tr>
        </thead>
        <tbody>
          <% Account.platforms.keys.each do |platform| %>
            <% stats = @platform_stats[platform] || { total: 0, active: 0, unlogged: 0, banned: 0 } %>
            <tr>
              <td style="padding: 8px;">
                <%= link_to platform.capitalize, admin_accounts_path(q: { platform_eq: Account.platforms[platform] }), class: "admin-link-quiet" %>
              </td>
              <td style="padding: 8px; text-align: center;"><%= stats[:total] %></td>
              <td style="padding: 8px; text-align: center; color: var(--success);"><%= stats[:active] %></td>
              <td style="padding: 8px; text-align: center; color: var(--warning);"><%= stats[:unlogged] %></td>
              <td style="padding: 8px; text-align: center; color: var(--danger);"><%= stats[:banned] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          储备资源状况
        </div>
        <div class="admin-card-subtitle">
          各主题下资源任务分布
        </div>
      </div>
      <div class="admin-card-header-right">
        <%= link_to admin_move_tasks_path(q: { status_eq: 0 }), class: "admin-tag" do %>
          待处理总计 <%= @move_tasks_pending %>
        <% end %>
      </div>
    </div>

    <div class="admin-table-wrapper" style="border: none; background: transparent; padding: 0;">
      <table class="admin-table" style="font-size: 11px;">
        <thead>
          <tr style="background: rgba(15, 23, 42, 0.3);">
            <th style="padding: 6px 8px;">内容主题</th>
            <% MoveTask.platforms.keys.each do |p| %>
              <th style="padding: 6px 4px; text-align: center; text-transform: capitalize;"><%= p.to_s[0..2] %></th>
            <% end %>
            <th style="padding: 6px 8px; text-align: center; background: rgba(59, 130, 246, 0.1);">总计</th>
          </tr>
        </thead>
        <tbody>
          <% if @theme_platform_stats.any? %>
            <% @theme_platform_stats.each do |theme, platforms| %>
              <tr>
                <td style="padding: 6px 8px;">
                  <%= link_to theme, admin_move_tasks_path(q: { theme_cont: theme, status_eq: 0 }), class: "admin-link-quiet", style: "font-weight: 500;" %>
                </td>
                <% MoveTask.platforms.keys.each do |p| %>
                  <td style="padding: 6px 4px; text-align: center; color: <%= platforms[p].to_i > 0 ? 'var(--text-primary)' : 'var(--text-muted)' %>;">
                    <% if platforms[p].to_i > 0 %>
                      <%= link_to platforms[p], admin_move_tasks_path(q: { theme_cont: theme, platform_eq: MoveTask.platforms[p], status_eq: 0 }), class: "admin-link-quiet", style: "color: inherit;" %>
                    <% else %>
                      0
                    <% end %>
                  </td>
                <% end %>
                <td style="padding: 6px 8px; text-align: center; font-weight: 600; color: <%= platforms[:total] < 5 ? 'var(--error)' : 'var(--accent)' %>; background: <%= platforms[:total] < 5 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.05)' %>;">
                  <%= platforms[:total] %>
                  <% if platforms[:total] < 5 %>
                    <span style="font-size: 10px; display: block; font-weight: normal;">库存不足</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="<%= MoveTask.platforms.size + 2 %>" style="padding: 16px; text-align: center;" class="admin-label-muted">暂无待处理任务</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="admin-grid-full">
  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          任务异常汇总
        </div>
        <div class="admin-card-subtitle">
          失败任务常见错误原因 Top 5
        </div>
      </div>
      <div class="admin-card-header-right">
        <%= link_to "查看所有失败任务", admin_move_tasks_path(q: { status_eq: 4 }), class: "admin-link-quiet" %>
      </div>
    </div>

    <% if @error_summary.any? %>
      <div class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th>错误描述</th>
              <th style="text-align: center; width: 100px;">出现次数</th>
              <th style="text-align: right; width: 120px;">操作</th>
            </tr>
          </thead>
          <tbody>
            <% @error_summary.each do |msg, count| %>
              <tr>
                <td>
                  <span class="admin-label-muted" style="color: var(--danger);" title="<%= msg %>"><%= truncate(msg, length: 50) %></span>
                </td>
                <td style="text-align: center;">
                  <span class="admin-badge"><%= count %></span>
                </td>
                <td style="text-align: right;">
                  <%= link_to "查看详情", admin_move_tasks_path(q: { status_eq: 4, error_msg_cont: msg }), class: "admin-link-quiet", style: "color: var(--accent);" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="admin-empty-state">
        目前暂无失败任务的错误汇总数据。
      </div>
    <% end %>
  </div>

  <div class="admin-card">
    <div class="admin-card-header">
      <div>
        <div class="admin-card-title">
          系统统计
        </div>
        <div class="admin-card-subtitle">
          历史运行数据概览
        </div>
      </div>
    </div>

    <div style="padding-top: 10px;">
      <div class="admin-card-subtitle" style="margin-bottom: 12px;">
        今日运行
      </div>
      <div style="display: flex; gap: 20px; margin-bottom: 24px;">
        <%= link_to admin_task_logs_path(q: { created_at_gteq: Time.zone.now.beginning_of_day }), class: "admin-link-card" do %>
          <div class="admin-label-muted" style="font-size: 11px;">
            产生日志
          </div>
          <div style="font-size: 18px; font-weight: 600;">
            <%= @today_logs_count %>
          </div>
        <% end %>
        <%= link_to admin_task_logs_path(q: { created_at_gteq: Time.zone.now.beginning_of_day, status_eq: 1 }), class: "admin-link-card" do %>
          <div class="admin-label-muted" style="font-size: 11px;">
            异常次数
          </div>
          <div style="font-size: 18px; font-weight: 600; color: <%= @today_errors_count > 0 ? 'var(--error)' : 'var(--text-primary)' %>;">
            <%= @today_errors_count %>
          </div>
        <% end %>
      </div>

      <div class="admin-card-subtitle" style="margin-bottom: 12px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
        总计运行
      </div>
      <div style="display: flex; gap: 20px;">
        <%= link_to admin_task_logs_path, class: "admin-link-card" do %>
          <div class="admin-label-muted" style="font-size: 11px;">
            总产生日志
          </div>
          <div style="font-size: 18px; font-weight: 600;">
            <%= @total_logs_count %>
          </div>
        <% end %>
        <%= link_to admin_task_logs_path(q: { status_eq: 1 }), class: "admin-link-card" do %>
          <div class="admin-label-muted" style="font-size: 11px;">
            总异常次数
          </div>
          <div style="font-size: 18px; font-weight: 600; color: <%= @total_errors_count > 0 ? 'var(--error)' : 'var(--text-primary)' %>;">
            <%= @total_errors_count %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
